<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky Audience Overlap Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f3f4f6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 14px;
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .input-group input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }
        
        .tip {
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
            margin-bottom: 12px;
        }
        
        .btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .alert {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .alert-info {
            background: #eff6ff;
            color: #1e40af;
        }
        
        .alert-error {
            background: #fef2f2;
            color: #991b1b;
        }
        
        .results {
            margin-top: 24px;
        }
        
        .results h2 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .account-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .account-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .account-handle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }
        
        .account-followers {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .account-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .comparison {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .comparison h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .metric {
            
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .breakdown-card {
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }
        
        .breakdown-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .breakdown-stat {
            font-size: 12px;
            color: #6b7280;
        }
        
        .three-way {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .three-way h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .insights {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 24px;
        }
        
        .insights h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e40af;
        }
        
        .insights ul {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.6;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Bluesky Audience Overlap Analyzer</h1>
            <p>Analyze follower OR engagement overlap between 2-3 Bluesky accounts. See who follows multiple creators, or who actively engages (likes, reposts, replies) with their content.</p>
        </div>

        <div class="card">
            <h2>Enter Bluesky Handles</h2>
            
            <div class="input-group">
                <label>Account 1</label>
                <input type="text" id="handle1" placeholder="e.g., midimyers.com or full URL">
            </div>
            
            <div class="input-group">
                <label>Account 2</label>
                <input type="text" id="handle2" placeholder="e.g., katelynburns.com or full URL">
            </div>
            
            <div class="input-group">
                <label>Account 3 (Optional)</label>
                <input type="text" id="handle3" placeholder="e.g., rascal.news or full URL">
            </div>
            
            <div class="tip">
                üí° Tip: You can paste either handles (e.g., "midimyers.com") or full URLs (e.g., "https://bsky.app/profile/midimyers.com")
            </div>
            
            <div style="margin-top: 20px; margin-bottom: 16px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Analysis Type</h3>
                
                <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 6px; cursor: pointer; margin-bottom: 8px;">
                    <input type="radio" name="analysisType" value="followers" checked style="margin-right: 12px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Follower Overlap</div>
                        <div style="font-size: 12px; color: #6b7280;">See which accounts follow multiple creators (faster, shows potential audience)</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                    <input type="radio" name="analysisType" value="engagement" style="margin-right: 12px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Engagement Overlap üî•</div>
                        <div style="font-size: 12px; color: #6b7280;">See who actively engages (likes, reposts, replies) with multiple creators (slower, shows engaged audience)</div>
                    </div>
                </label>
            </div>
            
            <div id="engagementSettings" style="display: none; padding: 12px; background: #fef3c7; border-radius: 6px; margin-bottom: 12px;">
                <div style="font-size: 13px; color: #92400e; margin-bottom: 8px;">
                    <strong>Engagement Analysis Settings:</strong>
                </div>
                <div class="input-group" style="margin-bottom: 8px;">
                    <label style="font-size: 13px;">Posts to analyze per account (1-50)</label>
                    <input type="number" id="postsToAnalyze" value="20" min="1" max="50" style="padding: 6px;">
                </div>
                <div style="font-size: 12px; color: #78350f;">
                    ‚ö° More posts = more accurate but slower. 20 posts takes ~2-3 minutes per account.
                </div>
            </div>
            
            <button class="btn" id="analyzeBtn" onclick="analyzeOverlap()">Analyze Overlap</button>
            
            <div id="progressDiv" style="display: none;" class="alert alert-info"></div>
            <div id="errorDiv" style="display: none;" class="alert alert-error"></div>
        </div>

        <div id="resultsDiv"></div>
    </div>

    <script>
        let isLoading = false;

        // Show/hide engagement settings based on analysis type
        document.addEventListener('DOMContentLoaded', function() {
            const radios = document.querySelectorAll('input[name="analysisType"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const engagementSettings = document.getElementById('engagementSettings');
                    if (this.value === 'engagement') {
                        engagementSettings.style.display = 'block';
                    } else {
                        engagementSettings.style.display = 'none';
                    }
                });
            });
        });

        function extractHandle(input) {
            input = input.trim();
            
            // If it's a URL, extract the handle from it
            if (input.includes('bsky.app/profile/')) {
                const match = input.match(/bsky\.app\/profile\/([^\/?#]+)/);
                if (match) {
                    return match[1];
                }
            }
            
            // If it starts with @, remove it
            if (input.startsWith('@')) {
                return input.slice(1);
            }
            
            return input;
        }

        function showProgress(message) {
            const div = document.getElementById('progressDiv');
            div.textContent = message;
            div.style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressDiv').style.display = 'none';
        }

        function showError(message) {
            const div = document.getElementById('errorDiv');
            div.textContent = '‚ùå ' + message;
            div.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorDiv').style.display = 'none';
        }

        async function getProfile(actor) {
            try {
                console.log('Fetching profile for:', actor);
                const response = await fetch(
                    `https://public.api.bsky.app/xrpc/app.bsky.actor.getProfile?actor=${encodeURIComponent(actor)}`
                );
                
                if (!response.ok) {
                    throw new Error(`Profile not found: ${actor} (Status: ${response.status})`);
                }
                
                const data = await response.json();
                console.log('Profile fetched successfully:', data.handle);
                return data;
            } catch (err) {
                console.error('Error in getProfile:', err);
                throw new Error(`Could not fetch profile for "${actor}". Check the handle is correct.`);
            }
        }

        async function fetchFollowers(actor, maxFollowers = null) {
            const followers = new Set();
            let cursor = null;
            let page = 0;
            
            while (true) {
                try {
                    let url = `https://public.api.bsky.app/xrpc/app.bsky.graph.getFollowers?actor=${encodeURIComponent(actor)}&limit=100`;
                    
                    if (cursor) {
                        url += `&cursor=${encodeURIComponent(cursor)}`;
                    }
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch followers: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.followers) {
                        data.followers.forEach(f => followers.add(f.did));
                    }
                    
                    page++;
                    showProgress(`Fetching ${actor}: ${followers.size.toLocaleString()} followers (page ${page})`);
                    
                    if (maxFollowers && followers.size >= maxFollowers) {
                        break;
                    }
                    
                    cursor = data.cursor;
                    if (!cursor) break;
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (err) {
                    console.error('Error fetching followers:', err);
                    throw err;
                }
            }
            
            return followers;
        }
        
        async function getAuthorFeed(actor, limit = 20) {
            try {
                const response = await fetch(
                    `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(actor)}&limit=${limit}`
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch posts: ${response.status}`);
                }
                
                const data = await response.json();
                return data.feed || [];
            } catch (err) {
                console.error('Error fetching posts:', err);
                return [];
            }
        }
        
        async function getPostLikes(postUri) {
            try {
                const response = await fetch(
                    `https://public.api.bsky.app/xrpc/app.bsky.feed.getLikes?uri=${encodeURIComponent(postUri)}&limit=100`
                );
                
                if (!response.ok) {
                    return [];
                }
                
                const data = await response.json();
                return (data.likes || []).map(like => like.actor.did);
            } catch (err) {
                return [];
            }
        }
        
        async function getPostReposts(postUri) {
            try {
                const response = await fetch(
                    `https://public.api.bsky.app/xrpc/app.bsky.feed.getRepostedBy?uri=${encodeURIComponent(postUri)}&limit=100`
                );
                
                if (!response.ok) {
                    return [];
                }
                
                const data = await response.json();
                return (data.repostedBy || []).map(user => user.did);
            } catch (err) {
                return [];
            }
        }
        
        async function getEngagedUsers(actor, maxPosts = 20) {
            const engagers = new Map(); // Map of DID -> engagement count
            
            showProgress(`Fetching posts from ${actor}...`);
            const feed = await getAuthorFeed(actor, maxPosts);
            
            showProgress(`Analyzing engagement on ${feed.length} posts from ${actor}...`);
            
            for (let i = 0; i < feed.length; i++) {
                const post = feed[i].post;
                const postUri = post.uri;
                
                showProgress(`${actor}: analyzing post ${i + 1}/${feed.length}`);
                
                // Get likes
                const likers = await getPostLikes(postUri);
                likers.forEach(did => {
                    const current = engagers.get(did) || 0;
                    engagers.set(did, current + 1);
                });
                
                // Get reposts
                const reposters = await getPostReposts(postUri);
                reposters.forEach(did => {
                    const current = engagers.get(did) || 0;
                    engagers.set(did, current + 2); // Reposts weighted 2x
                });
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            showProgress(`Found ${engagers.size.toLocaleString()} engaged users for ${actor}`);
            return new Set(engagers.keys());
        }

        function getInterpretation(jaccard) {
            if (jaccard > 50) return { label: 'Very High', color: '#10b981', emoji: '‚≠ê' };
            if (jaccard > 30) return { label: 'High', color: '#3b82f6', emoji: '‚úÖ' };
            if (jaccard > 15) return { label: 'Moderate', color: '#f59e0b', emoji: 'üìä' };
            if (jaccard > 5) return { label: 'Low', color: '#ef4444', emoji: 'üìâ' };
            return { label: 'Minimal', color: '#6b7280', emoji: '‚ö™' };
        }

        async function analyzeOverlap() {
            if (isLoading) return;
            
            isLoading = true;
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            
            hideError();
            hideProgress();
            document.getElementById('resultsDiv').innerHTML = '';
            
            try {
                // Get handles
                const handle1 = document.getElementById('handle1').value;
                const handle2 = document.getElementById('handle2').value;
                const handle3 = document.getElementById('handle3').value;
                
                const validHandles = [handle1, handle2, handle3]
                    .filter(h => h.trim() !== '')
                    .map(h => extractHandle(h));
                
                console.log('Extracted handles:', validHandles);
                
                if (validHandles.length < 2) {
                    throw new Error('Please enter at least 2 handles');
                }
                
                // Fetch profiles
                showProgress('Fetching profiles...');
                const profiles = [];
                for (const handle of validHandles) {
                    const profile = await getProfile(handle);
                    profiles.push(profile);
                }
                
                // Check analysis type
                const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
                const isEngagementAnalysis = analysisType === 'engagement';
                
                let audienceSets = [];
                let audienceLabel = 'followers';
                
                if (isEngagementAnalysis) {
                    // Fetch engaged users
                    const maxPosts = parseInt(document.getElementById('postsToAnalyze').value) || 20;
                    showProgress('Analyzing engagement...');
                    audienceLabel = 'engaged users';
                    
                    for (let i = 0; i < profiles.length; i++) {
                        const engagedUsers = await getEngagedUsers(profiles[i].did, maxPosts);
                        audienceSets.push(engagedUsers);
                    }
                } else {
                    // Fetch followers
                    showProgress('Fetching followers...');
                    for (let i = 0; i < profiles.length; i++) {
                        const followers = await fetchFollowers(profiles[i].did);
                        audienceSets.push(followers);
                    }
                }
                
                // Calculate overlaps
                showProgress('Calculating overlaps...');
                
                const pairwiseOverlaps = [];
                
                for (let i = 0; i < profiles.length; i++) {
                    for (let j = i + 1; j < profiles.length; j++) {
                        const overlap = new Set([...audienceSets[i]].filter(x => audienceSets[j].has(x)));
                        const totalUnique = new Set([...audienceSets[i], ...audienceSets[j]]);
                        const jaccardIndex = (overlap.size / totalUnique.size) * 100;
                        
                        pairwiseOverlaps.push({
                            account1: profiles[i],
                            account2: profiles[j],
                            followers1: audienceSets[i].size,
                            followers2: audienceSets[j].size,
                            overlap: overlap.size,
                            overlapPct1: (overlap.size / audienceSets[i].size) * 100,
                            overlapPct2: (overlap.size / audienceSets[j].size) * 100,
                            jaccard: jaccardIndex,
                            unique1: audienceSets[i].size - overlap.size,
                            unique2: audienceSets[j].size - overlap.size,
                            audienceType: audienceLabel
                        });
                    }
                }
                
                // 3-way overlap
                let threeWayOverlap = null;
                if (profiles.length === 3) {
                    const overlap3 = new Set(
                        [...audienceSets[0]].filter(x => 
                            audienceSets[1].has(x) && audienceSets[2].has(x)
                        )
                    );
                    threeWayOverlap = overlap3.size;
                }
                
                displayResults(profiles, audienceSets, pairwiseOverlaps, threeWayOverlap, audienceLabel, isEngagementAnalysis);
                hideProgress();
                
            } catch (err) {
                console.error('Analysis error:', err);
                showError(err.message);
            } finally {
                isLoading = false;
                btn.disabled = false;
                btn.textContent = 'Analyze Overlap';
            }
        }

        function displayResults(profiles, audienceSets, pairwiseOverlaps, threeWayOverlap, audienceLabel = 'followers', isEngagementAnalysis = false) {
            const resultsDiv = document.getElementById('resultsDiv');
            
            let html = '<div class="results"><h2>üìä Results</h2>';
            
            // Account summaries
            html += '<div class="account-grid">';
            profiles.forEach((profile, idx) => {
                html += `
                    <div class="account-card">
                        <div class="account-name">${profile.displayName || profile.handle}</div>
                        <div class="account-handle">@${profile.handle}</div>
                        <div class="account-followers">${audienceSets[idx].size.toLocaleString()}</div>
                        <div class="account-label">${audienceLabel}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Pairwise comparisons
            pairwiseOverlaps.forEach(comp => {
                const interp = getInterpretation(comp.jaccard);
                const capitalizedLabel = audienceLabel.charAt(0).toUpperCase() + audienceLabel.slice(1);
                
                html += `
                    <div class="comparison">
                        <h3>${comp.account1.displayName} ‚Üî ${comp.account2.displayName}</h3>
                        
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Shared ${capitalizedLabel}</div>
                                <div class="metric-value" style="color: #10b981;">${comp.overlap.toLocaleString()}</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">${isEngagementAnalysis ? 'Engagement' : 'Audience'} Similarity</div>
                                <div class="metric-value" style="color: ${interp.color};">${comp.jaccard.toFixed(1)}%</div>
                            </div>
                            
                            <div class="metric">
                                <div class="metric-label">Interpretation</div>
                                <div class="metric-value" style="color: ${interp.color}; font-size: 18px;">${interp.emoji} ${interp.label}</div>
                            </div>
                        </div>
                        
                        <div class="breakdown-grid">
                            <div class="breakdown-card">
                                <div class="breakdown-title">${comp.account1.displayName}</div>
                                <div class="breakdown-stat">Unique: ${comp.unique1.toLocaleString()} (${((comp.unique1 / comp.followers1) * 100).toFixed(1)}%)</div>
                                <div class="breakdown-stat">Shared: ${comp.overlap.toLocaleString()} (${comp.overlapPct1.toFixed(1)}%)</div>
                            </div>
                            
                            <div class="breakdown-card">
                                <div class="breakdown-title">${comp.account2.displayName}</div>
                                <div class="breakdown-stat">Unique: ${comp.unique2.toLocaleString()} (${((comp.unique2 / comp.followers2) * 100).toFixed(1)}%)</div>
                                <div class="breakdown-stat">Shared: ${comp.overlap.toLocaleString()} (${comp.overlapPct2.toFixed(1)}%)</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // 3-way overlap
            if (threeWayOverlap !== null) {
                const capitalizedLabel = audienceLabel.charAt(0).toUpperCase() + audienceLabel.slice(1);
                html += `
                    <div class="three-way">
                        <h3>üéØ Three-Way Overlap</h3>
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                            ${capitalizedLabel} who ${isEngagementAnalysis ? 'engage with' : 'follow'} ALL THREE accounts:
                        </div>
                        <div style="font-size: 36px; font-weight: bold; color: #8b5cf6;">
                            ${threeWayOverlap.toLocaleString()}
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                            This is your core ${isEngagementAnalysis ? 'engaged' : 'shared'} audience
                        </div>
                    </div>
                `;
            }
            
            // Insights
            html += '<div class="insights"><h3>üí° Insights for Trustfund</h3><ul>';
            
            if (isEngagementAnalysis) {
                html += '<li><strong>Engagement analysis shows active participants</strong> - These are users who like, repost, and reply to content, not just passive followers. They\'re your most valuable audience segment.</li>';
                
                if (pairwiseOverlaps[0].jaccard > 15) {
                    html += '<li><strong>High engagement overlap</strong> - These creators share highly active audience members who engage with both. Perfect for co-created content or collaborative newsletters.</li>';
                }
                if (pairwiseOverlaps[0].jaccard >= 8 && pairwiseOverlaps[0].jaccard <= 15) {
                    html += '<li><strong>Moderate engagement overlap</strong> - Good mix of shared engaged users and unique audiences. Bundle opportunities could convert engaged followers from one creator to the other.</li>';
                }
                if (pairwiseOverlaps[0].jaccard < 8) {
                    html += '<li><strong>Distinct engaged audiences</strong> - These creators have mostly different active communities. Collaborations could expose each to entirely new engaged audiences.</li>';
                }
                if (pairwiseOverlaps[0].overlap > 50) {
                    html += `<li><strong>${pairwiseOverlaps[0].overlap.toLocaleString()} shared engaged users</strong> - This core group actively engages with both creators. They\'re prime candidates for premium bundled content.</li>`;
                }
            } else {
                if (pairwiseOverlaps[0].jaccard > 30) {
                    html += '<li><strong>High follower overlap</strong> - These creators compete for the same audience. Collaborations should focus on complementary content to avoid redundancy.</li>';
                }
                if (pairwiseOverlaps[0].jaccard >= 15 && pairwiseOverlaps[0].jaccard <= 30) {
                    html += '<li><strong>Moderate overlap</strong> - Ideal for newsletter bundles. Shared interest shows compatibility, but each brings new readers to the other.</li>';
                }
                if (pairwiseOverlaps[0].jaccard < 15) {
                    html += '<li><strong>Low overlap</strong> - Great potential for cross-promotion. Each creator can reach largely new audiences through collaboration.</li>';
                }
                if (threeWayOverlap && threeWayOverlap > 100) {
                    html += `<li><strong>Strong 3-way core audience</strong> - ${threeWayOverlap.toLocaleString()} people follow all three creators, making this an excellent bundle opportunity.</li>`;
                }
            }
            
            html += '</ul></div>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
